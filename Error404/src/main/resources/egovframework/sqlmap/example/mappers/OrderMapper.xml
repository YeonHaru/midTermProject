<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="egovframework.example.order.service.impl.OrderMapper">

<insert id="insertOrder" parameterType="OrderVO" useGeneratedKeys="false">
  <selectKey resultType="int" keyProperty="ono" order="BEFORE">
    SELECT ORDER_SEQ.NEXTVAL FROM DUAL
  </selectKey>
  INSERT INTO MEMBER_ORDERS (ONO, USERID, ODATE, OSTATUS, TOTAL)
  VALUES (#{ono}, #{userid}, SYSDATE, #{ostatus}, #{total})
</insert>

<select id="getOrderByOno" parameterType="int" resultMap="orderResultMap">
    SELECT * FROM MEMBER_ORDERS WHERE ono = #{ono}
</select>


<insert id="insertOrderItem" parameterType="OrderItemVO">
    INSERT INTO ORDER_ITEM_M (ONO, BNO, QTY, PRICE)
    VALUES (#{ono}, #{bno}, #{qty}, #{price})
</insert>

<select id="getOrdersByUserid" parameterType="string" resultMap="orderResultMap">
    SELECT * FROM MEMBER_ORDERS WHERE USERID = #{userid} ORDER BY ODATE DESC
</select>

<resultMap id="orderResultMap" type="OrderVO">
    <id property="ono" column="ono"/>
    <result property="userid" column="userid"/>
    <result property="odate" column="odate"/>
    <result property="ostatus" column="ostatus"/>
    <result property="total" column="total"/>

    <!-- 여기서는 resultMap 쓰지 말고 select만 -->
    <collection property="items" ofType="OrderItemVO"
                column="ono"
                select="getItemsByOno"/>
</resultMap>

<resultMap id="orderItemWithBookMap" type="OrderItemVO">
    <id property="ono" column="ono"/>
    <result property="bno" column="bno"/>
    <result property="qty" column="qty"/>
    <result property="price" column="price"/>

    <association property="book" javaType="egovframework.example.book.service.BookVO">
        <id property="bno" column="book_bno"/>
        <result property="title" column="book_title"/>
        <result property="dprice" column="book_dprice"/>
    </association>
</resultMap>



<select id="getItemsByOno" parameterType="int" resultMap="orderItemWithBookMap">
    SELECT 
        oi.ONO,
        oi.BNO,
        oi.QTY,
        oi.PRICE,
        b.BNO AS book_bno,
        b.TITLE AS book_title,
        b.DPRICE AS book_dprice
    FROM ORDER_ITEM_M oi
    JOIN BOOKS b ON oi.bno = b.bno
    WHERE oi.ono = #{ono}
</select>

</mapper>